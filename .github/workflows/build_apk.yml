name: Build Android APK (remote)

on:
  workflow_dispatch: {}
  push:
    branches:
      - main
      - master
      - feat/app-contents-and-quality-improvements

jobs:
  build_apk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17 (required by Gradle/AGP)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Diagnostics - Flutter and Java
        run: |
          java -version || true
          flutter --version
          flutter doctor -v || true

      - name: Prepare keystore and key.properties
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          STORE_PASS: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASS: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          mkdir -p android/app
          if [ -n "${KEYSTORE_BASE64}" ]; then
            echo "Decoding keystore from secret to android/app/keystore.jks"
            echo "${KEYSTORE_BASE64}" | base64 --decode > android/app/keystore.jks
            printf "storePassword=%s\nkeyPassword=%s\nkeyAlias=%s\nstoreFile=android/app/keystore.jks\n" "${STORE_PASS}" "${KEY_PASS}" "${KEY_ALIAS}" > key.properties
          else
            echo "No KEYSTORE_BASE64 secret found - generating ephemeral keystore on runner"
            # Ephemeral keystore; not suitable for Play Store updates. Change passwords if desired.
            TEMP_STORE_PASS=tempStorePass123
            TEMP_KEY_PASS=tempKeyPass123
            TEMP_ALIAS=temp_key
            keytool -genkeypair -v -keystore android/app/keystore.jks -storepass ${TEMP_STORE_PASS} -keypass ${TEMP_KEY_PASS} -alias ${TEMP_ALIAS} -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Code Sprout, OU=Dev, O=Code Sprout, L=City, S=State, C=US"
            printf "storePassword=%s\nkeyPassword=%s\nkeyAlias=%s\nstoreFile=android/app/keystore.jks\n" "${TEMP_STORE_PASS}" "${TEMP_KEY_PASS}" "${TEMP_ALIAS}" > key.properties
          fi

      - name: Create google-services.json (from secret)
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          if [ -n "${GOOGLE_SERVICES_JSON}" ]; then
            mkdir -p android/app
            printf "%s" "${GOOGLE_SERVICES_JSON}" > android/app/google-services.json
            echo "Wrote android/app/google-services.json from secret"
          else
            echo "No GOOGLE_SERVICES_JSON secret found; skipping creation of android/app/google-services.json"
          fi

      - name: Flutter pub get
        run: flutter pub get

      - name: Write firebase_options.dart from secrets
        env:
          FIREBASE_WEB_API_KEY: ${{ secrets.FIREBASE_WEB_API_KEY }}
          FIREBASE_WEB_APP_ID: ${{ secrets.FIREBASE_WEB_APP_ID }}
          FIREBASE_WEB_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_WEB_MESSAGING_SENDER_ID }}
          FIREBASE_WEB_PROJECT_ID: ${{ secrets.FIREBASE_WEB_PROJECT_ID }}
          FIREBASE_WEB_AUTH_DOMAIN: ${{ secrets.FIREBASE_WEB_AUTH_DOMAIN }}
          FIREBASE_WEB_STORAGE_BUCKET: ${{ secrets.FIREBASE_WEB_STORAGE_BUCKET }}
          FIREBASE_WEB_MEASUREMENT_ID: ${{ secrets.FIREBASE_WEB_MEASUREMENT_ID }}

          FIREBASE_ANDROID_API_KEY: ${{ secrets.FIREBASE_ANDROID_API_KEY }}
          FIREBASE_ANDROID_APP_ID: ${{ secrets.FIREBASE_ANDROID_APP_ID }}
          FIREBASE_ANDROID_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_ANDROID_MESSAGING_SENDER_ID }}
          FIREBASE_ANDROID_PROJECT_ID: ${{ secrets.FIREBASE_ANDROID_PROJECT_ID }}
          FIREBASE_ANDROID_STORAGE_BUCKET: ${{ secrets.FIREBASE_ANDROID_STORAGE_BUCKET }}

          FIREBASE_IOS_API_KEY: ${{ secrets.FIREBASE_IOS_API_KEY }}
          FIREBASE_IOS_APP_ID: ${{ secrets.FIREBASE_IOS_APP_ID }}
          FIREBASE_IOS_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_IOS_MESSAGING_SENDER_ID }}
          FIREBASE_IOS_PROJECT_ID: ${{ secrets.FIREBASE_IOS_PROJECT_ID }}
          FIREBASE_IOS_STORAGE_BUCKET: ${{ secrets.FIREBASE_IOS_STORAGE_BUCKET }}
          FIREBASE_IOS_BUNDLE_ID: ${{ secrets.FIREBASE_IOS_BUNDLE_ID }}
        run: |
          mkdir -p lib
          printf "%s\n" "// Generated by CI from repository secrets" > lib/firebase_options.dart
          printf "import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;\n" >> lib/firebase_options.dart
          printf "import 'package:flutter/foundation.dart' show defaultTargetPlatform, kIsWeb, TargetPlatform;\n\n" >> lib/firebase_options.dart
          printf "class DefaultFirebaseOptions {\n  static FirebaseOptions get currentPlatform {\n    if (kIsWeb) {\n      return web;\n    }\n    switch (defaultTargetPlatform) {\n      case TargetPlatform.android:\n        return android;\n      case TargetPlatform.iOS:\n        return ios;\n      case TargetPlatform.macOS:\n        throw UnsupportedError('DefaultFirebaseOptions have not been configured for macos - you can reconfigure this by running the FlutterFire CLI again.');\n      case TargetPlatform.windows:\n        throw UnsupportedError('DefaultFirebaseOptions have not been configured for windows - you can reconfigure this by running the FlutterFire CLI again.');\n      case TargetPlatform.linux:\n        throw UnsupportedError('DefaultFirebaseOptions have not been configured for linux - you can reconfigure this by running the FlutterFire CLI again.');\n      default:\n        throw UnsupportedError('DefaultFirebaseOptions are not supported for this platform.');\n    }\n  }\n\n" >> lib/firebase_options.dart
          printf "  static const FirebaseOptions web = FirebaseOptions(\n    apiKey: '%s',\n    appId: '%s',\n    messagingSenderId: '%s',\n    projectId: '%s',\n    authDomain: '%s',\n    storageBucket: '%s',\n    measurementId: '%s',\n  );\n\n" "${FIREBASE_WEB_API_KEY}" "${FIREBASE_WEB_APP_ID}" "${FIREBASE_WEB_MESSAGING_SENDER_ID}" "${FIREBASE_WEB_PROJECT_ID}" "${FIREBASE_WEB_AUTH_DOMAIN}" "${FIREBASE_WEB_STORAGE_BUCKET}" "${FIREBASE_WEB_MEASUREMENT_ID}" >> lib/firebase_options.dart
          printf "  static const FirebaseOptions android = FirebaseOptions(\n    apiKey: '%s',\n    appId: '%s',\n    messagingSenderId: '%s',\n    projectId: '%s',\n    storageBucket: '%s',\n  );\n\n" "${FIREBASE_ANDROID_API_KEY}" "${FIREBASE_ANDROID_APP_ID}" "${FIREBASE_ANDROID_MESSAGING_SENDER_ID}" "${FIREBASE_ANDROID_PROJECT_ID}" "${FIREBASE_ANDROID_STORAGE_BUCKET}" >> lib/firebase_options.dart
          printf "  static const FirebaseOptions ios = FirebaseOptions(\n    apiKey: '%s',\n    appId: '%s',\n    messagingSenderId: '%s',\n    projectId: '%s',\n    storageBucket: '%s',\n    iosBundleId: '%s',\n  );\n}\n" "${FIREBASE_IOS_API_KEY}" "${FIREBASE_IOS_APP_ID}" "${FIREBASE_IOS_MESSAGING_SENDER_ID}" "${FIREBASE_IOS_PROJECT_ID}" "${FIREBASE_IOS_STORAGE_BUCKET}" "${FIREBASE_IOS_BUNDLE_ID}" >> lib/firebase_options.dart

      - name: Build release APK
        run: flutter build apk --release -v

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: build/app/outputs/flutter-apk/app-release.apk
